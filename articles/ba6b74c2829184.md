---
title: "pythonã®runtimeã§å‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ã—ãŸã„"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python"]
published: true
---

## ã¯ã˜ã‚ã«

ç­†è€…ã¯æ¥­å‹™ã§ä¸»ã«æ©Ÿæ¢°å­¦ç¿’å‘¨ã‚Šã®é–‹ç™ºã‚’è¡Œã£ã¦ã„ã¦å‹å‘¨ã‚Šã®ç†è«–ã‚„å®Ÿè·µã«ã¤ã„ã¦ã¯è©³ã—ã„æ–¹ã§ã¯ãªã„ã“ã¨ã‚’å…ˆã«æ–­ã£ã¦ãŠãã¾ã™ã€‚ã“ã®è¨˜äº‹ã¯å­¦ç¿’ãƒãƒ¼ãƒˆã®ä½“ã‚’ã—ãŸãƒãƒ©ã‚·ã®è£ã§ã™ã€‚

è‡ªåˆ†ã¯ã‚­ãƒ£ãƒªã‚¢ã®åºç›¤ã‹ã‚‰å‰²ã¨pythonã®type hintã‚’ã¤ã‘ã¦é–‹ç™ºã—ã¦ããŸã®ã§ã™ãŒã‚ã‚‹ã‹ãªã„ã‹ã§ã‹ãªã‚Šã‚³ãƒ¼ãƒ‰ã®èª­ã¿ã‚„ã™ã•ã¯å¤‰ã‚ã£ã¦ãã‚‹ã¨æ€ã£ã¦ã¾ã™ã€‚
mypyã‚„pyrightã«ã‚ˆã£ã¦é™çš„è§£æã§å‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ã§ãã‚‹ã®ã§ã“ã®è¨˜äº‹ã§æ›¸ãã»ã©runtimeã§ãƒã‚§ãƒƒã‚¯ã—ãŸã„ã“ã¨ã¯ã‚ã¾ã‚Šãªã„ã®ã§ã™ãŒruntimeã§ã‚‚ãƒã‚§ãƒƒã‚¯ã—ãŸã„ã¨è¨€ã£ã¦ã‚‹äººã‚’è¦‹ã‹ã‘ãŸã®ã§ã€è‡ªåˆ†ãŒçŸ¥ã£ã¦ã‚‹æ–¹æ³•ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚
ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚å‹ã«ã—ã‚ã‚„ã€Immutableã«ã—ã‚ã€ã¨ã¯è€ƒãˆã¦ãªããƒãƒ©ãƒ³ã‚¹ãŒå¤§äº‹ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
ã‚ãã¾ã§ã‚‚ã‹ã£ã¡ã‚Šä½œã‚‹éƒ¨åˆ†ã«ãŠã„ã¦ä½¿ãˆã‚‹ã‹ã‚‚ãªãã‚‰ã„ã§ã™ã€‚å®‰å…¨æ€§ã‚‚é«˜ã‚ã¤ã¤ã‚¹ã‚±ãƒ¼ãƒ«ã—ã‚„ã™ã„è¨­è¨ˆã‚’ç›®æŒ‡ã—ã¦æ—¥ã€…å‹‰å¼·ã—ã¦ã„ã¾ã™ã€‚

å‰ç½®ããŒé•·ããªã‚Šã¾ã—ãŸãŒã€ã“ã®è¨˜äº‹ã§ã¯pythonã§runtimeã«å‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦beartypeã¨pydanticã‚’ç´¹ä»‹ã—ã¾ã™ã€‚pythonã®å‹å‘¨ã‚Šã«ã¤ã„ã¦ã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚

pythonã®å‹ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹[1]ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«type hintã‚’ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://future-architect.github.io/articles/20201223/

## ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- beartype
- pydantic

pythonã®versionã¯æ‰‹å…ƒã«å…¥ã£ã¦ã„ãŸ3.9.2ã‚’ä½¿ã£ã¦ã„ã¾ã™

ãã‚Œãã‚Œä»¥ä¸‹ã®versionã‚’ä½¿ã£ã¦macOS13.4(Intel Core i7)ã§å‹•ä½œç¢ºèªã—ã¦ã„ã¾ã™ã€‚

- beartype: 0.14.0
- pydantic: 1.10.8

```bash
pip install beartype pydantic
```

```bash
poetry add beartype pydantic
```

## beartype

beartype[2]ã¯near-real-timeã®pythonã®runtimeã§é–¢æ•°ã®å¼•æ•°ã‚„è¿”ã‚Šå€¤ã®å‹ãƒã‚§ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
Readmeã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€decoratorã‚’ä½¿ã£ã¦pythonã®é–¢æ•°ã®å¼•æ•°ã‚„è¿”ã‚Šå€¤ã®å‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

-Oã‚’ã¤ã‘ã¦pythonã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`__debug__`ã«FalseãŒå…¥ã£ã¦ã€beartypeã®runtimeã®å‹ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€TYPE_CHECKINGãŒTrueã‹ã€`__debug__`ãŒFalseã®æ™‚ã«ã¯ã€beartype decoratorã¯ä½•ã‚‚ã—ãªã„ã§å¼•æ•°ã«ã¨ã£ãŸObjectã‚’ãã®ã¾ã¾è¿”ã™ã“ã¨ã§type checkã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

https://github.com/beartype/beartype/blob/main/beartype/_decor/decormain.py#L60-L100

åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```python
from beartype import beartype

# å¼•æ•°ã®å‹ãŒstrã§è¿”ã‚Šå€¤ã®å‹ãŒstrã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
@beartype
def hello(name: str) -> str:
    return f"Hello {name}"
```

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€é–¢æ•°ã‚’å‘¼ã³å‡ºã™æ™‚ã«runtimeã«ãŠã‘ã‚‹å¼•æ•°ã®å‹ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
hello(name="world")
# >>> Hello world
```

type hintã¨é•ã†å‹ã‚’æ¸¡ã™ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```python
hello(name=1)
# >>> Function __main__.hello() parameter name=1 violates type hint <class 'str'>, as int 1 not instance of str.
```

ã¾ãŸlistãªã©ã‚‚ãƒã‚§ã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
from beartype import beartype

@beartype
def hello_names(names: list[str]) -> str:
    return f"Hello {', '.join(names)}!"

print(hello_names(names=["world", "python", "nnc_5522"]))
# >>> Hello world, python, nnc_5522!
```

Unionãªã©ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
from typing import Union

@beartype
def hello_union(name: Union[str, int]) -> str:
    return f"Hello {name}!"

print(hello_union(name="world"))
print(hello_union(name=100))
# >>> Hello world!
# >>> Hello 100!

hello_union(name=1.0)
# >>> Function __main__.hello_union() parameter name=1.0 violates type hint typing.Union[str, int], as float 1.0 not str or int.
```

3.9.xä»¥ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚‹æ™‚ã«ã€annotationsã‚’importã™ã‚‹ã“ã¨ã§type hintã¨ã—ã¦typing.Unionã‚’ä½¿ã‚ãšã«ç›´å’Œå‹ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã“ã‚Œã¯type hintã®è©•ä¾¡ã‚’é…ã‚‰ã›ã¦ã‚‹ã ã‘ã§typeåŒå£«ã®æ¼”ç®—ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¨³ã§ã¯ãªã„ã®ã§ã€beartypeã§ã¯ãƒã‚§ãƒƒã‚¯ã§ãã¾ã›ã‚“ã€‚ãŠã¨ãªã—ãtyping.Unionã‚’ä½¿ã†ã¹ãã§ã™ã€‚

```python
from __future__ import annotations

@beartype
def hello_union(name: str | int) -> str:
    return f"Hello {name}!"

print(hello_union(name="world"))

```

:::details raiseã•ã‚Œã‚‹ä¾‹å¤–

```text
Traceback (most recent call last):
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/peps/_pep563.py", line 584, in resolve_pep563
    func_hints_resolved[pith_name] = eval(
  File "<string>", line 1, in <module>
TypeError: unsupported operand type(s) for |: 'type' and 'type'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/chibadaimare/work/example_beartype_pydantic/main.py", line 16, in <module>
    def hello_union(name: str | int) -> str:
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/_decor/_cache/cachedecor.py", line 77, in beartype
    return beartype_object(obj, conf)
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/_decor/decorcore.py", line 195, in beartype_object
    return _beartype_func(  # type: ignore[return-value]
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/_decor/decorcore.py", line 637, in _beartype_func
    bear_call.reinit(func, conf, **kwargs)
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/_check/checkcall.py", line 341, in reinit
    resolve_pep563(
  File "/Users/chibadaimare/.pyenv/versions/3.9.2/lib/python3.9/site-packages/beartype/peps/_pep563.py", line 621, in resolve_pep563
    raise BeartypePep563Exception(
beartype.roar.BeartypePep563Exception: function __main__.hello_union() parameter "name" PEP 563-postponed type hint 'str | int' syntactically invalid (i.e., "unsupported operand type(s) for |: 'type' and 'type'") under:
~~~~[ GLOBAL SCOPE ]~~~~
{'__name__': '__main__', '__doc__': None, '__package__': None, '__loader__': <_frozen_importlib_external.SourceFileLoader object at 0x1065c81c0>, '__spec__': None, '__annotations__': {}, '__builtins__': <module 'builtins' (built-in)>, '__file__': '/Users/chibadaimare/work/example_beartype_pydantic/main.py', '__cached__': None, 'annotations': _Feature((3, 7, 0, 'beta', 1), (3, 10, 0, 'alpha', 0), 16777216), 'beartype': <function beartype at 0x106925550>, 'hello': <function hello at 0x106668d30>, 'hello_names': <function hello_names at 0x106a488b0>}
~~~~[ LOCAL SCOPE  ]~~~~
{}
```

:::

numpy.ndarrayãªã©ã®third partyã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹ã§ã‚‚ãƒã‚§ãƒƒã‚¯å¯èƒ½ã§ã™

```python
@beartype
def np_add(a: np.ndarray, b: np.ndarray) -> np.ndarray:
    return a + b

print(np_add(a=np.array([1, 2, 3]), b=np.array([4, 5, 6])))
# >>> [5 7 9]

# Error Case
print(np_add(a=[1, 2, 3], b=np.array([4, 5, 6])))
# >>> Function __main__.np_add() parameter a=[1, 2, 3] violates type hint <class 'numpy.ndarray'>, as list [1, 2, 3] not instance of <protocol "numpy.ndarray">.
```

ã•ã‚‰ã«dtypeãªã©ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
@beartype
def np_diff(a: NDArray[np.float16], b: NDArray[np.float16]) -> np.ndarray:
    return b - a

print(
    np_diff(
        a=np.array([1, 2, 3], dtype=np.float16),
        b=np.array([4, 5, 6], dtype=np.float16),
    )
)
# >>> [3. 3. 3.]

np_diff(
    a=np.array([1, 2, 3], dtype=np.float64),
    b=np.array([4, 5, 6], dtype=np.float16),
)
# >>> Function __main__.np_diff() parameter a="array([1., 2., 3.])" violates type hint numpy.
# ... ndarray[typing.Any, numpy.dtype[numpy.float16]],
# ... as <protocol "numpy.ndarray"> "array([1., 2., 3.])" violates validator numpy.ndarray[typing.Any, numpy.dtype[numpy.float16]]:
# ...   False == numpy.ndarray[typing.Any, numpy.dtype[numpy.float16]].
```

ã‚‚ã¡ã‚ã‚“ã€pytorchã®tensorãªã©ã‚‚ãƒã‚§ãƒƒã‚¯å¯èƒ½ã§ã™ã€‚

```python
@beartype
def torch_add(a: torch.Tensor, b: torch.Tensor) -> torch.Tensor:
    return a + b

print(torch_add(a=torch.tensor([1, 2, 3]), b=torch.tensor([4, 5, 6])))
# >>> tensor([5, 7, 9])
```

é¡ä¼¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦typeguard[3]ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ãŒã€beartypeãŒå‡ºã—ã¦ã‚‹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è¦‹ã‚‹ã¨ã€å‘¼ã³å‡ºã—ã¾ã§å«ã‚ã‚‹ã¨beartypeã®æ–¹ãŒæ—©ã„å°è±¡ã§ã™ã€‚

![](/images/ba6b74c2829184/bench_beartype.png)
*å›³1: ç”»åƒã¯https://beartype.readthedocs.io/en/latest/math/ã‚ˆã‚Šå¼•ç”¨*

## pydantic

pydanticã¯ã€pythonã®å‹ãƒ’ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯`pydantic.BaseModel`ã‚’ç¶™æ‰¿ã—ã¦å‹ãƒ’ãƒ³ãƒˆã‚’æ›¸ãã¨runtimeã§ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã£ã¦ãã‚Œã¾ã™ã€‚
æ©Ÿæ¢°å­¦ç¿’ã‚’æ™®æ®µä¸»ã«ã‚„ã‚‹äººã§ã‚ã£ã¦ã‚‚FastAPIã‚’ä½¿ã£ã¦APIæä¾›ãªã©ã‚’ã‚„ã£ã¦ã„ã‚Œã°è§¦ã£ãŸã“ã¨ã‚„èã„ãŸã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

pydanticã®æ—¥æœ¬èªã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®è¨˜äº‹[4]ãªã©å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://zenn.dev/hayata_yamamoto/articles/python-pydantic

åŸºæœ¬çš„ã«ã¯ä¸Šã§ç´¹ä»‹ã•ã‚Œã¦ã‚‹é€šã‚Šãªã®ã§ã™ãŒã€åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
from pydantic import BaseModel, Field

class User(BaseModel):
    name: str = Field(..., description="åå‰")
    age: int = Field(..., description="å¹´é½¢")
```

dictã‚„listã¯default_factoryã‚’ä½¿ã£ã¦ä¸ãˆã¾ã™

```python
from typing import Optional
from pathlib import Path

class Request(BaseModel):
    id: int = Field(..., description="ID")
    image_name: str = Field(..., description="ç”»åƒå")
    model_path: Path = Field(..., description="ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹")
    additional_config: Optional[dict[str, Union[str, float, bool]]] = Field(
        default_factory=lambda: {"tta": False}, description="è¿½åŠ è¨­å®š"
    )

```

`pydantic.BaseModel`ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã¯`dict()`ã‚’å‘¼ã¶ã“ã“ã¨ã§è¾æ›¸ã«å¤‰æ›ã§ãã€ã¾ãŸ`json()`ã‚’å‘¼ã¶ã“ã¨ã§json(æ–‡å­—åˆ—)ã«å¤‰æ›ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šç°¡å˜ã«serializeã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã¾ãŸå…¥ã‚Œå­ã«ãªã£ãŸã‚¯ãƒ©ã‚¹ã§ã‚ã£ã¦ã‚‚`dict()`ã§è¾æ›¸ã«å¤‰æ›ã§ãã¾ã™ã€‚

```python

class EstimatedResult(BaseModel):
    value: list[int] = Field(..., description="æ¨è«–çµæœ")
    shape: tuple[int, int] = Field(..., description="æ¨è«–çµæœã®shape")


class Response(BaseModel):
    ids: list[int] = Field(..., description="ID")
    estimated_result: EstimatedResult = Field(..., description="æ¨è«–çµæœ")
    model_path: Path = Field(..., description="ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹")


estimated = EstimatedResult(value=[1, 2, 3], shape=(3, 1))
response = Response(
    ids=[1, 2, 3],
    estimated_result=estimated,
    model_path=Path("weighs/model1.pth"),
)
print(response.dict())
# >>> {'ids': [1, 2, 3], 'estimated_result': {'value': [1, 2, 3], 'shape': (3, 1)}, 'model_path': PosixPath('weighs/model1.pth')}

```

ã¾ãŸé€†ã«ã€jsonã‚„dictã‹ã‚‰ã‚‚åˆæœŸåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸ`schema()`ã‚’å‘¼ã¶ã“ã¨ã§Json Schemaãªã©ã‚’è¿”ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
è©³ç´°ã¯[5]ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã€Configã‚’è¨­å®šã™ã‚‹ã“ã¨ã§immutableã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```python
from pydantic import BaseModel, Field

class ImmutableResponse(BaseModel):
    ids: list[int] = Field(..., description="ID")
    estimated_result: EstimatedResult = Field(..., description="æ¨è«–çµæœ")
    model_path: Path = Field(..., description="ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹")

    class Config:
        frozen = True  # å…¨Fieldã‚’immutableã«ã™ã‚‹


immutable_response = ImmutableResponse(
    ids=[1, 2, 3],
    estimated_result=estimated,
    model_path=Path("weighs/model1.pth"),
)

try:
    immutable_response.estimated_result = [1000000, 100000, 1000000]
except Exception as e:
    print(e)
# >>> "ImmutableResponse" is immutable and does not support item assignment
```

ç‰¹å®šã®Fieldã ã‘immutableã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```python
class ResponseConainsImmutableField(BaseModel):
    """
    Ref:
    [1] https://docs.pydantic.dev/latest/usage/schema/#field-customization
    """

    # allow_mutation=Falseã§ã“ã®Fieldã®ã¿immutable
    ids: list[int] = Field(..., allow_mutation=False, description="ID")
    estimated_result: EstimatedResult = Field(..., description="æ¨è«–çµæœ")
    model_path: Path = Field(..., description="ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹")

    class Config:
        # to check to be performed
        validate_assignment = True

# ids Fieldã®ã¿immutable
response_contains_immutable_field = ResponseConainsImmutableField(
    ids=[1, 2, 3],
    estimated_result=estimated,
    model_path=Path("weighs/model1.pth"),
)
# OK
response_contains_immutable_field.model_path = Path("weights/model2.pth")
# Fail
response_contains_immutable_field.ids = [1111, 1111, 1111]
# >>> "ids" has allow_mutation set to False and cannot be assigned
```

ãã®ä»–ã«ã‚‚Fieldã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãæ­£è¦è¡¨ç¾ã§validationã—ãŸã‚Šã€é•·ã•ã‚’åˆ¶é™ã§ããŸã‚Šã•ã¾ã–ã¾ãªvalidationãŒã§ãã¾ã™ã€‚
è©³ç´°ã¯[6]ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

dataclasses.dataclassã¨ã¯ã“ã®ã‚ãŸã‚Šã®runtimeã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ»å‹ã®validationã®æœ‰ç„¡ãŒãŠãŠããªå·®åˆ†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã®validationã¯ä»¥ä¸‹ã®ã‚ˆã†ã«validator decoratorã‚’ä½¿ã£ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```python
class ExampleWithValidation(BaseModel):
    ids: list[int] = Field(..., description="ID")

    @validator("ids")
    def is_less_than_10(cls, value: list[int]) -> list[int]:
        if not all([v < 10 for v in value]):
            raise ValueError(f"Expected id is less than 10, but got {value}")
        return value


# Example with validation
# OK
_ = ExampleWithValidation(ids=[1, 2, 3])
# Fail
try:
    _ = ExampleWithValidation(ids=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10])
except ValidationError as e:
    print(e)
# >>> 1 validation error for ExampleWithValidation
# ... ids
# ...  Expected id is less than 10, but got [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] (type=value_error)
```

pydanticã«ã‚‚é–¢æ•°ã®å¼•æ•°ã®å‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹decoratorãŒå­˜åœ¨ã—ã¾ã™ã€‚[7]
v1.5ã§è¿½åŠ ã•ã‚Œã€ã¾ã betaç‰ˆã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

beartypeã®ã‚ˆã†ã«å‹ãŒé•ã£ãŸå ´åˆã«ä¾‹å¤–ã‚’æŠ•ã’ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã‚‹ã®ã§ã™ãŒã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§floatã‚’æœŸå¾…ã—ã¦ã‚‹å¼•æ•°ã«intã‚’æ¸¡ã—ã¦ã‚‚ä¾‹å¤–ãŒæŠ•ã’ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

ã“ã“ã¯ãªãœãªã®ã‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€é™ã‚Šã§ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

ãŸã ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã«ã€æ•°å€¤ï¼ˆfloat)ã‚’æœŸå¾…ã—ã¦ã„ã‚‹å¼•æ•°ã«æ–‡å­—åˆ—ã‚’æ¸¡ã™ã¨ä¾‹å¤–ã‚’æŠ•ã’ã¦ãã‚Œã¾ã—ãŸã€‚

```python
@validate_arguments
def sample_fn(a: int, b: float) -> float:
    return a * b

# Example with validate_arguments
# OK
print(sample_fn(1, 2.0))
# >>> 2.0

# Fail?
try:
    print(sample_fn(1, 2))
except ValidationError as e:
    print(e)
# >>> 2.0

# Fail
try:
    print(sample_fn(1, "test"))
except ValidationError as e:
    print(e)
# æƒ³å®šå¤–ã‚¨ãƒ©ãƒ¼
except Exception as e:
    print(e)
# >>> 1 validation error for SampleFn
# ... b
# ...   value is not a valid float (type=type_error.float)
```

æ•°å€¤ã«å¯æ›ãªæ–‡å­—åˆ—ã‚’æ¸¡ã—ãŸå ´åˆã«ã¯æ•°å€¤ã«å¤‰æ›ã—ã¦è¨ˆç®—ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã§ã™ï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰

```python
try:
    print(sample_fn(1, "2"))
except ValidationError as e:
    print(e)
# æƒ³å®šå¤–ã‚¨ãƒ©ãƒ¼
except Exception as e:
    print(e)
# >>> 2.0
```

betaç‰ˆã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šã€é–¢æ•°ã®å‹ã®ãƒã‚§ãƒƒã‚¯ãªã©ã¯beartypeã‚’åˆ©ç”¨ã™ã‚‹æ–¹ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

<!--https://docs.pydantic.dev/latest/usage/validation_decorator/-->


ã¾ãŸç¾åœ¨pydanticã¯v2ã®é–‹ç™ºãŒé€²ã‚“ã§ã„ã¾ã™ã€‚[8] READMEã«ã‚ˆã‚‹ã¨ã¾ã production readyã§ã¯ãªã„ã‚ˆã†ãªã®ã§ã™ãŒpyo3ã‚’ç”¨ã„ã¦Rustã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã€ã‹ãªã‚Šé«˜é€Ÿã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
æœ€è¿‘ã§ã¯polarsãªã©æ©Ÿæ¢°å­¦ç¿’å‘¨ã‚Šã§ã‚‚Rustè£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¢—ãˆã¦ãã¦ã„ã‚‹ã®ã§æ¥½ã—ã¿ã§ã™ã€‚

## ã¾ã¨ã‚

pythonã®runtimeã§å‹ã®validationã‚’è¡Œã†æ–¹æ³•ã¨ã—ã¦beartypeã¨pydanticã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
beartypeã¯é–¢æ•°ã®å…¥å‡ºåŠ›ã®å‹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ãŒã§ãã€pydanticã¯å‹ã‚„ãƒ‡ãƒ¼ã‚¿ã®validationã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã¯ã‚ã‚‹ã‚‚ã®ã®pydanticã§ã‚‚é–¢æ•°ã®å…¥å‡ºåŠ›ã®å‹ã®ãƒã‚§ãƒƒã‚¯ã¯ã§ããªãã¯ãªã‘ã„ã©beartypeã‚’ä½¿ã†ã»ã†ãŒç¾çŠ¶ã¯è‰¯ã•ãã†ã§ã—ãŸã€‚(è‡ªåˆ†ã®èª¿æŸ»ä¸è¶³ã‹ã‚‚)

æ‰‹è»½ã«ã‹ã‘ã‚‹pythonã§ã™ãŒã€ã¡ã‚ƒã‚“ã¨ã—ãŸã‚‚ã®ã‚’ä½œã‚ã†ã¨ã™ã‚‹ã¨é›£ã—ã„éƒ¨åˆ†ã‚‚ã‚ã‚Šã¾ã™ã€‚
å°‘ãªãã¦ã‚‚type hintã¨ã—ã¦å‹ã‚’æ›¸ã„ã¦èª­ã‚€äººãŒé–¢æ•°ã®æ„å›³ã‚’æŠŠæ¡ã—ã‚„ã™ãã™ã‚‹ã€é™çš„è§£æã§ãƒã‚°ã®æ··å…¥ã‚’ã§ãã‚‹ã ã‘é˜²ãã¯å¾Œã€…ã®è‡ªåˆ†ã®ãŸã‚ã«ã‚‚å¿…é ˆã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ãã®ä¸Šã§beartypeã‚„pydanticã‚’ä½¿ã£ã¦å‹ã‚„ãƒ‡ãƒ¼ã‚¿ã®validationã‚’è¡Œã†ã“ã¨ã§å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“é—‡é›²ã«ä½¿ãˆã°ã„ã„è¨³ã§ã¯ãªãã€æŸ”è»Ÿæ€§ã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æ„è­˜ã—ã¦ä½¿ã£ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€‚ã€‚

ã©ã“ã¾ã§å³ã—ããƒã‚§ãƒƒã‚¯ã—ã¦ã‚„ã‚‹ã‹ã¯é–‹ç™ºè€…ã®å±ã—ã¦ã‚‹ãƒãƒ¼ãƒ ã‚„éƒ¨ç½²ã®æ–‡åŒ–æ¬¡ç¬¬ãªé¢ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å°‘ãªãã¦ã‚‚è‡ªåˆ†ãŒçµŒé¨“ã—ã¦ããŸç¯„å›²ã§ã¯type hintã¯å°‘ãªãã¦ã‚‚æ›¸ã„ã¦ã„ãŸæ–¹ãŒé–‹ç™ºä½“é¨“ã¯ä¸ŠãŒã‚‹ã®ã§type hintã¯æ›¸ãã¾ã—ã‚‡ã†ã€‚

è¨˜äº‹ä¸­ã«æ²è¼‰ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆã§ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/daikichiba9511/example_beartype_pydantic

## å‚è€ƒ

[1] https://future-architect.github.io/articles/20201223/
[2] https://github.com/beartype/beartype
[3] https://github.com/agronholm/typeguard
[4] https://zenn.dev/hayata_yamamoto/articles/python-pydantic
[5] https://pydantic-docs.helpmanual.io/usage/models/#json-serialisation-dict-conversion
[6] https://pydantic-docs.helpmanual.io/usage/schema/#field-customization
[7] https://docs.pydantic.dev/latest/usage/validation_decorator/
[8] https://docs.pydantic.dev/latest/blog/pydantic-v2/
