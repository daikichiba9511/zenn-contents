---
title: "AWS Lambda ã® Container Runtime ã‚’ GitHub Actions ã§ E2E ãƒ†ã‚¹ãƒˆã—ãŸã„æ™‚ã®å‚™å¿˜éŒ²"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [
  "githubactions",
  "docker",
  "python",
  "test"
]
published: true
---

# AWS Lambda ã® Container Runtime ã‚’ GitHub Actions ã§ E2E ãƒ†ã‚¹ãƒˆã—ãŸã„æ™‚ã®å‚™å¿˜éŒ²

## ã¯ã˜ã‚ã«

æ©Ÿæ¢°å­¦ç¿’ã®APIæä¾›ã¨ã—ã¦ AWS Lambda ã® Container Runtime ã‚’ä½¿ã†ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚
pytest ãªã©ã‚’ç”¨ã„ã¦é–‹ç™ºç’°å¢ƒã§ unit test ã¯ã‚ˆãè¡Œã„ã¾ã™ãŒã€ã•ã‚‰ã«Docker Container ã¨ã—ã¦ã®æˆæœç‰©ã® E2E ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šå®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã¯ã“ã® E2E ãƒ†ã‚¹ãƒˆã‚’ GitHub Acitons ä¸Šã§è¡Œã†ãŸã‚ã®å‚™å¿˜éŒ²ã§ã™ã€‚

ã»ã¨ã‚“ã©ã®å†…å®¹ã¯ä»¥ä¸‹ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã¾ã™ã€‚(ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ™‡ )

@[card](https://blog.ojisan.io/container-test-on-gha)

å·®åˆ†ã¯pythonã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã‚‹ã“ã¨ãã‚‰ã„ã ã¨æ€ã‚ã‚Œã¾ã™ã€‚

ãªã®ã§ã€è©³ç´°ã¯å¼•ç”¨ã—ã¦ã‚‹ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### æƒ³å®šèª­è€…

- AWS Lambdaã®ã‚³ãƒ³ãƒ†ãƒŠã‚’GHAä¸Šã§E2Eãƒ†ã‚¹ãƒˆã—ãŸã„æœªæ¥ã®è‡ªåˆ†

## GitHub Actionsã§ã®Test Job

GtiHub ACtionsä¸Šã§ã®ãƒ†ã‚¹ãƒˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml
name: test

on: push

jobs:
  test:
    name: Run E2E Test on Docker Containers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Run E2E Test on Docker Containers through Docker Network
        run: docker compose up server -d && docker compose up test
```

ãƒã‚¤ãƒ³ãƒˆã¯ã€AWS Lambda Container ã‚’ `docker compose up server -d` ã§æ¨è«–ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ãƒãƒƒã‚¯ãƒ—ãƒ­ã‚»ã‚¹ã§ç«‹ã¡ä¸Šã’ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦ã‚‹ã¨ã“ã‚ã§ã™ã€‚
ã“ã†ã—ãªã„ã¨ã†ã¾ãå‹•ãã¾ã›ã‚“ã€‚step é–“ã§ã¯ç’°å¢ƒãŒåˆ†ã‹ã‚Œã¦ã‚‹ã®ã§ã€åŒä¸€ã‚¹ãƒ†ãƒƒãƒ—å†…ã§ãƒ†ã‚¹ãƒˆã—ãŸã„æ¨è«–ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ã€åˆ¥ã®ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

pytest ãªã‚‰ E2E ç”¨ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã«ã¤ã‘ã¦ãŠãã¿ãŸã„ãªå·¥å¤«ã‚‚ã‚ã£ã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ç‰¹åˆ¥ãªã“ã¨ã¯ã—ã¦ã¾ã›ã‚“ãŒã€æ©Ÿæ¢°å­¦ç¿’ã® E2E ãƒ†ã‚¹ãƒˆã¯ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã‚„æ¨è«–ãªã©é‡ã‚ã®å‡¦ç†ãŒä¹—ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€develop ãƒ–ãƒ©ãƒ³ãƒã« pushã—ãŸæ™‚ã®ã¿ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚ˆã†ãªè¨­å®šã‚’ä»˜ã‘è¶³ã—ã¦ãŠãã¨ã„ã„ã¨æ€ã„ã¾ã™

```yaml
name: test

on: push

jobs:
  test:
    name: Run E2E Test on Docker Containers
    runs-on: ubuntu-latest
    # develop/mainãƒ–ãƒ©ãƒ³ãƒã«pushã—ãŸæ™‚ã®ã¿ãƒˆãƒªã‚¬ãƒ¼
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Run E2E Test on Docker Containers through Docker Network
        run: docker compose up server -d && docker compose up test
```

## å„ Dockerfile ã¨ AWS Lambda ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

### æ¨è«–ç”¨ã® Dockerfile

æ¨è«–ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã® Dockerfile ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

python ã®ç’°å¢ƒæ§‹ç¯‰ã« rye ã‚’ä½¿ã£ã¦ã‚‹ã®ã§ rye ã§ç”Ÿæˆã•ã‚ŒãŸ lock ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ã€LAMBDA_TASK_ROOT ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```Dockerfile
FROM public.ecr.aws/lambda/python:3.10 as app

WORKDIR ${LAMBDA_TASK_ROOT}

# README.md,pyproject.tomlãŒãªã„ã¨installæ™‚ã«ã‚³ã‚±ã‚‹
COPY README.md pyproject.toml requirements.lock "${LAMBDA_TASK_ROOT}"
RUN \
  python -m pip install --upgrade \
      'pip==24.2' \
      'wheel==0.43.0' \
      'setuptools==72.1.0' && \
  python -m pip install --no-cache-dir -r requirements.lock -t "${LAMBDA_TASK_ROOT}"
COPY . "${LAMBDA_TASK_ROOT}"
CMD [ "src.example_aws_lambda_e2e_test_on_gha.app.handler" ]

```

### E2E ãƒ†ã‚¹ãƒˆç”¨ã® Dockerfile

E2E ãƒ†ã‚¹ãƒˆç”¨ã® Dockerfile ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```Dockerfile
FROM python:3.10 AS builder

ENV ORIGIN=http://localhost:8080
WORKDIR /app

COPY . .
RUN \
    python -m pip install --upgrade \
      'pip==24.2' \
      'wheel==0.43.0' \
      'setuptools==72.1.0' && \
    pip install -r requirements.lock && \
    pip install -r requirements-dev.lock

CMD ["pytest"]
```

### æ¨è«–ç”¨ã‚³ãƒ¼ãƒ‰ã¨ãã® E2E ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

æ¨è«–ç”¨ã® lambda function ã®ã‚³ãƒ¼ãƒ‰ã¯ä»Šå›ä½•ã§ã‚‚ã„ã„ã®ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã‚‰ã€ `message` ã‚­ãƒ¼ã§ããŸã‚‚ã®ã‚’è¿”ã™ã ã‘ã®ç°¡å˜ãªã‚‚ã®ã«ã—ã¦ã¾ã™ã€‚

```python
from enum import Enum
from aws_lambda_powertools.utilities.typing import LambdaContext


class Status(Enum):
    OK = 200
    BAD_REQUEST = 400
    FORBIDDEN = 403
    NOT_FOUND = 404
    INTERNAL_SERVER_ERROR = 500


def handler(event: dict, _: LambdaContext) -> dict:
    msg = event.get("message")
    status = Status.OK
    if msg is None:
        msg = "Not Found"
        status = Status.BAD_REQUEST
    return {"message": msg, "status": status.value}

```

E2E ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æ¨è«–ã‚µãƒ¼ãƒãƒ¼ã«Docker Network çµŒç”±ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã‚ˆã†ã«ã—ã¾ã™

```python
import os
import json
import requests
import pytest


ORIGIN = os.getenv("ORIGIN", "http://localhost:8080")


@pytest.fixture
def sample_success_request() -> str:
    return json.dumps({"message": "Hello, World!"})


def test_app_should_success(sample_success_request: str) -> None:
    response = requests.get(
        f"{ORIGIN}/2015-03-31/functions/function/invocations",
        data=sample_success_request,
    )

    assert getattr(response, "status_code") == 200, (
        f"Requested to {ORIGIN}. Expected status code 200, but got {response.status_code} "
        + "You should check the environment variable ORIGIN in compose.yaml. "
        + "If you are on GitHub Action, please check 'http://server:8080' is allowed. "
    )

    response_json = response.json()
    assert response_json.get("message") == "Hello, World!", (
        f"Requested to {ORIGIN}. Expected message 'Hello, World!', but got {response_json.get('message')} "
        + f"RESPONSE_JSON: {response_json}"
    )
```

ä»¥ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã¦ã€GitHub Actions ä¸Šã§ E2E ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

![lambda_e2e_gha_log_20240804.png](/images/54ced2bf154d2c/lambda_e2e_gha_log_20240804.png)

ã‚³ãƒ¼ãƒ‰ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

@[card](https://github.com/daikichiba9511/example-aws-lambda-e2e-test-on-gha)

## ã¾ã¨ã‚

- AWS Lambda ã® Container Runtime ã‚’ä½¿ã£ãŸ E2E ãƒ†ã‚¹ãƒˆã‚’ GitHub Actions ä¸Šã§è¡Œã†æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã—ãŸ
- Docker Network ã‚’ä½¿ã£ã¦æ¨è«–ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ã“ã¨ã§ E2E ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™
